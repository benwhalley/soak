<!DOCTYPE html>

<html>
<meta charset="UTF-8">

<head>
    <title>Qualitative Analysis Report</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap-grid.min.css" integrity="sha512-uzG4YY/dpwIEUrfjYud6T7ieVM06DwkHYiB28wgbtq0w4hSGx3XyDF2Oh/VaxB0hmyxyR3hYHNQc4Chb/dS1Sw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap-reboot.min.css" integrity="sha512-Hvxqga90bvpEid1McCftiBMcfB8cPXI+TZR3GVf4KUdLu3NPx6/gPXSQTdY7AHaLLJDSJym6kOotc713b2D7gQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" integrity="sha512-rt/SrQ4UNIaGfDyEXZtNcyWvQeOq0QLygHluFQcSjaGB04IxWhal71tKuzP6K8eYXYB6vJV4pHkXcmFGGQ1/0w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js" integrity="sha512-igl8WEUuas9k5dtnhKqyyld6TzzRjvMqLC79jkgT3z02FvJyHAuUtyemm/P/jYSne1xwFI06ezQxEwweaiV7VA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>


<body>

  <div class="container">
    <h1>Qualitative Analysis Report</h1>

  <div class="row">
    <div class="col-6">

      <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.8.1/mermaid.min.js" integrity="sha512-BFmLwKC92En/Mv3/tTlkzotbuaJlvgUvGRyDh1037lTgKhP326tEL1mDN0wl8kXC/ZbNsKd7mT4iOjFC+EhoNg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

      <style>
        .mermaid-container {
          background-color: #f8f9fa;
          border: 1px solid #dee2e6;
          padding: 20px;
        }
        .mermaid {
          text-align: center;
        }
        .mermaid-header {
          font-weight: bold;
          margin-bottom: 10px;
          color: #333;
        }
      </style>

      <div class="mermaid-container">
        <div class="mermaid">
          {{ pipeline.to_mermaid()|safe }}
        </div>
      </div>


      <script>
        mermaid.initialize({
          startOnLoad: true,
          theme: 'default',
          flowchart: {
            useMaxWidth: true,
            htmlLabels: true,
            curve: 'basis'
          }
        });
      </script>


      <h5 class="mt-4">Default context</h5>
      <ul class="list-group">
        <li class="list-group-item">Pipeline: <code>{{pipeline.name}}</code></li>

        {% for k, v in pipeline.default_context.items() %}
        <li class="list-group-item">{{k}}:<code> {{v}}</code></li>
        {% endfor %}

      </ul>

      {% if pipeline.config.extra_context %}
      <h5 class="mt-4">Extra context</h5>
      <ul class="list-group">
        {% for k, v in pipeline.config.extra_context.items() %}
        <li class="list-group-item">{{k}}:<code> {{v}}</code></li>
        {% endfor %}
      </ul>
      {% endif %}

     <h5 class="mt-4">Contents:</h5>
      <ul class="list-group">
        <li class="list-group-item"><a href="#narrative">Narrative</a></li>

        <li class="list-group-item"><a href="#themes">Themes</a></li>
        <li class="list-group-item"><a href="#codes">Codes</a></li>
        <li class="list-group-item"><a href="#quotes">Quotes</a></li>

        <li class="list-group-item"><a href="#documents">Document paths</a></li>
      </ul>

    </div>

    <div class="col-6">
      <h5>Themes</h5>
      <ul>
        {% for t in result.themes %}
        <li>{{t.name}}</li>
        {% endfor %}
      </ul>


    <h5 class="mt-4">Codes</h5>
      <ul>
        {% for t in result.codes %}
        <li>{{t.name}}</li>
        {% endfor %}
      </ul>
    </div>


  </div>


  <hr class="mt-5">

  <h2 id="narrative">Narrative</h2>
  <div>
{% markdown %}
{{ result.narrative }}
{% endmarkdown %}
  </div>




  <hr class="mt-5">

  <h2 id="themes">Themes</h2>
  {% for theme in result.themes %}
  <div class="theme mt-4">
    <h5>{{ theme.name }}</h5>
    <p>{{ theme.description }}</p>
    <p>Linked codes:
      {% for code in theme.code_names %}
        {{code}}{% if not loop.last %}, {% endif %}
      {% endfor %}
    </p>
  </div>
  {% endfor %}

  <hr class="mt-5">

  <h1 id="codes">Codes and supporting quotes</h1>
  {% for code in result.codes %}
  <div class="mt-2 card card-body">
    <h6 class="card-title">{{ code.name }}</h6>
    <p>{{ code.description }}</p>
    {% if code.quotes %}
    <p>Example Quotes:</p>
    <ul>
      {% for quote in code.quotes %}
      <li>{{ quote }}</li>
      {% endfor %}
    </ul>
    {% endif %}
  </div>
  {% endfor %}


  <hr class="mt-5">

<h1 id="quotes">Checking quotes</h1>
  <div>
    <style>
  .sim-high   { color: green; }
  .sim-mid    { color: orange; }
  .sim-low    { color: red; }
  .sim-verylow { color: grey; }
</style>

<table class="table">
  <tr>
    <th>LLM Extracted Quote</th>
    <th>Matches in original text</th>
  </tr>
  {% for q in result.quotes.output %}
  <tr>
    <td>{{ q.quote|e }}</td>
    <td>
      <ul>
      {% for match, sim in q.matches %}
        {% set cls = "sim-verylow" %}
        {% if sim > 0.7 %}
          {% set cls = "sim-high" %}
        {% elif sim > 0.6 %}
          {% set cls = "sim-mid" %}
        {% elif sim > 0.5 %}
          {% set cls = "sim-low" %}
        {% endif %}
        <li class="{{ cls }}">
         {{ match|e }} (sim.:  {{ "%.2f"|format(sim) }})
        </li>
      {% endfor %}
      </ul>
    </td>
  </tr>
  {% endfor %}
</table>


  <h2>Stats on matching quotes</h2>
  <pre style="white-space: pre-wrap;">
    {{ result.quotes.stats }}
  </pre>
  </div>

  <hr class="mt-5">




</div>




 <div class="col-12">

      {% if pipeline.config.document_paths %}
      <hr>
      <h2 class="mt-4" id="documents">Documents</h5>
      <ul class="list-group">
        {% for k in pipeline.config.document_paths %}
        <li class="list-group-item">{{k}}</code></li>
        {% endfor %}
      </ul>
      {% endif %}


    </div>


</div>
